<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Assisting Enrolment Eligibility Check</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        /* Custom scrollbar for better feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        .step-transition { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .input-warning {
            color: #ef4444; /* red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }
        .text-shadow {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="quiz-container" class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 transition duration-500">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6 text-shadow">
            Dental Assisting Eligibility
        </h1>

        <!-- Step Counter / Progress -->
        <div id="progress-container" class="mb-6">
            <div class="h-2 bg-gray-200 rounded-full">
                <div id="progress-bar" class="h-2 bg-blue-500 rounded-full transition-all duration-300" style="width: 0;"></div>
            </div>
            <p id="step-counter" class="text-sm text-center text-gray-500 mt-2">Step 1 of 5</p>
        </div>

        <!-- Main Content Area -->
        <div id="step-content" class="min-h-[200px] mb-6">
            <p class="text-center text-gray-500">Loading...</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col space-y-3">
            <button id="next-button" onclick="nextStep()"
                class="w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                disabled>
                Next Step
            </button>
            <button id="restart-button" onclick="startQuiz()"
                class="w-full py-3 px-6 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition duration-300 hidden">
                Restart Quiz
            </button>
            <button id="history-button" onclick="renderHistory()"
                class="w-full py-2 px-6 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-300 hidden">
                View My Results History
            </button>
        </div>

        <!-- Status Messages -->
        <p id="save-status-message" class="text-sm mt-4 text-center hidden"></p>
        
        <!-- User ID Display (MANDATORY for multi-user apps) -->
        <p id="user-id-display" class="text-xs text-gray-400 mt-6 text-center break-all">User ID: Loading...</p>
    </div>

    <!-- Firebase SDK Imports (MUST BE loaded before script block) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, getDocs, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Globals to be initialized ---
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        // --- Auth & Init Function ---
        window.initializeFirebase = async function() {
            setLogLevel('debug'); // Enable Firestore logging

            // Global variables provided by the environment (MANDATORY USE)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                document.getElementById('step-content').innerHTML = '<p class="text-center text-red-500">Error: Firebase configuration missing.</p>';
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using the custom token or anonymously if the token is missing
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up auth state change listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        // Start the quiz/initial view now that we are authenticated
                        window.startQuiz();
                        // Make Firestore instances available globally
                        window.db = db;
                        window.auth = auth;
                        window.userId = userId;
                        window.appId = appId; // Pass appId to global scope
                        document.getElementById('history-button').classList.remove('hidden');
                    } else {
                        userId = null;
                        isAuthReady = true; // Still ready, just unauthenticated (shouldn't happen here)
                        document.getElementById('user-id-display').textContent = `User ID: Not Signed In`;
                        window.startQuiz(); // Attempt to start even if unauthenticated
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('step-content').innerHTML = '<p class="text-center text-red-500">Authentication Error: See console.</p>';
            }
        };

        // --- Global Quiz State (Available in the main script block) ---
        window.currentStepIndex = 0;
        window.currentVisibleStep = 1;
        window.answers = {};
        window.quizHistory = []; // New array to store fetched results

        // --- Firestore Utilities ---
        const QUIZ_RESULTS_COLLECTION_NAME = 'dental_assisting_quiz_results';

        /**
         * Saves the final quiz result to Firestore.
         * @param {object} result - The result object from getQuizResult.
         * @param {object} finalAnswers - The complete answers object.
         */
        window.saveQuizResult = async function(result, finalAnswers) {
            if (!window.db || !window.userId) {
                console.error("Firestore not initialized or user ID missing.");
                return;
            }
            
            const statusMessage = document.getElementById('save-status-message');
            statusMessage.classList.remove('hidden', 'text-green-500', 'text-red-500');
            statusMessage.classList.add('text-yellow-600');
            statusMessage.textContent = 'Saving result...';

            const userPath = `/artifacts/${window.appId}/users/${window.userId}/${QUIZ_RESULTS_COLLECTION_NAME}`;

            try {
                // Prepare data for saving
                const dataToSave = {
                    timestamp: Timestamp.fromDate(new Date()), // Use Firestore Timestamp
                    category: result.category,
                    program: result.program,
                    message: result.message,
                    title: result.title,
                    answers: finalAnswers,
                };

                // Add the document to the user's private collection
                const docRef = await addDoc(collection(window.db, userPath), dataToSave);
                
                console.log("Document written with ID: ", docRef.id);
                statusMessage.textContent = 'Result saved successfully!';
                statusMessage.classList.remove('text-yellow-600');
                statusMessage.classList.add('text-green-500');
            } catch (e) {
                console.error("Error adding document: ", e);
                statusMessage.textContent = 'Error saving result.';
                statusMessage.classList.remove('text-yellow-600');
                statusMessage.classList.add('text-red-500');
            }
        }
        
        /**
         * Loads the user's past quiz history from Firestore.
         */
        window.loadQuizHistory = async function() {
            if (!window.db || !window.userId) {
                console.error("Firestore not initialized or user ID missing.");
                return;
            }

            const userPath = `/artifacts/${window.appId}/users/${window.userId}/${QUIZ_RESULTS_COLLECTION_NAME}`;
            
            try {
                // Fetch documents from the collection path
                const querySnapshot = await getDocs(collection(window.db, userPath));
                
                window.quizHistory = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    window.quizHistory.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Sort the history by timestamp descending (most recent first)
                window.quizHistory.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                
                window.renderHistory(); // Re-render to display loaded history
            } catch (e) {
                console.error("Error fetching quiz history: ", e);
                document.getElementById('step-content').innerHTML = `
                    <p class="text-center text-red-500">Failed to load history.</p>
                    <p class="text-center text-sm text-gray-500">${e.message}</p>
                `;
            }
        }
        
        /**
         * Renders the history screen.
         */
        window.renderHistory = function() {
            document.getElementById('next-button').classList.add('hidden');
            document.getElementById('restart-button').classList.remove('hidden');
            document.getElementById('history-button').textContent = 'Return to Quiz Start';
            document.getElementById('history-button').onclick = window.startQuiz;

            const contentDiv = document.getElementById('step-content');
            
            let historyHTML = `
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">My Quiz History</h2>
            `;

            if (window.quizHistory.length === 0) {
                historyHTML += '<p class="text-center text-gray-500">No previous quiz results found. Complete a quiz to save your first result!</p>';
            } else {
                historyHTML += '<div class="space-y-4 max-h-[400px] overflow-y-auto pr-2">';
                
                window.quizHistory.forEach((result, index) => {
                    // Format the timestamp
                    const date = result.timestamp?.toDate ? result.timestamp.toDate() : new Date();
                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    historyHTML += `
                        <div class="p-4 border border-gray-200 rounded-lg shadow-sm ${index === 0 ? 'bg-blue-50 border-blue-200' : 'bg-white'}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-medium text-gray-500">${formattedDate}</span>
                                ${index === 0 ? '<span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">LATEST</span>' : ''}
                            </div>
                            <p class="text-md font-bold text-gray-900">${result.title}</p>
                            <p class="text-sm text-blue-600 mt-1">${result.program}</p>
                            <p class="text-sm text-gray-600">Category: ${result.category}</p>
                            <p class="text-xs text-gray-500 mt-2 italic">${result.message.substring(0, 100)}...</p>
                        </div>
                    `;
                });

                historyHTML += '</div>';
            }
            
            contentDiv.innerHTML = historyHTML;
        }

    </script>

    <!-- Main Quiz Logic and UI Functions -->
    <script>
        // --- Step Definitions ---
        const steps = [
            { 
                question: "1. Are you currently an Australian citizen or a permanent resident?", 
                name: "residency",
                options: [
                    { label: "Yes, I am an Australian citizen/permanent resident.", value: "yes" },
                    { label: "No, I am not.", value: "no" }
                ],
                type: "radio"
            },
            { 
                question: "2. What is your current employment status?", 
                name: "employment",
                options: [
                    { label: "Employed in a dental practice (Student Dentist/Dental Assistant).", value: "dental_employed" },
                    { label: "Employed in a non-dental field.", value: "non_dental_employed" },
                    { label: "Unemployed.", value: "unemployed" }
                ],
                type: "radio"
            },
            { 
                question: "3. Have you completed Year 12 or equivalent education?", 
                name: "education",
                options: [
                    { label: "Yes, I have completed Year 12 or higher.", value: "yes" },
                    { label: "No, I have not completed Year 12.", value: "no" }
                ],
                type: "radio"
            },
            { 
                question: "4. Do you hold any other Australian government-subsidised vocational qualifications (e.g., Certificate IV or higher)?", 
                name: "qualification_held",
                options: [
                    { label: "Yes, I have a higher vocational qualification.", value: "yes" },
                    { label: "No, or I am unsure.", value: "no" }
                ],
                type: "radio"
            },
            { 
                question: "5. Please enter your email address to receive the results (Required):", 
                name: "email",
                type: "text",
                placeholder: "e.g., john.doe@example.com",
                validation: (value) => {
                    if (!value) return "Email is required.";
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) return "Please enter a valid email address.";
                    return null; // Valid
                }
            }
        ];

        // --- Result Logic ---
        const results = {
            'eligible_dental_employed': { 
                title: "Highly Likely Eligible for Subsidised Training", 
                message: "Based on your current employment in a dental practice and meeting residency requirements, you are highly likely eligible for subsidised training. You must be employed as a Student Dentist/Dental Assistant.", 
                program: "Certificate III/IV in Dental Assisting (Subsidised)", 
                category: "Subsidised / Fee Exemption" 
            },
            'eligible_general': { 
                title: "Potentially Eligible for Subsidised Training", 
                message: "You meet the general residency requirements and education level, but your eligibility is contingent on meeting specific government funding criteria (e.g., not having a prior higher qualification). We will verify your exact eligibility.", 
                program: "Certificate III/IV in Dental Assisting (Subsidised/Co-payment)", 
                category: "Co-payment / Subsidised" 
            },
            'fee_paying_qualification': { 
                title: "Likely Fee-Paying Student", 
                message: "As you currently hold a higher vocational qualification, you may not be eligible for government funding and will need to pay the full fee. We will confirm the exact fee upon submission.", 
                program: "Certificate III/IV in Dental Assisting (Student)", 
                category: "State-based co-payment / Fee-paying student" 
            },
            'fee_paying_residency': { 
                title: "Fee-Paying Student - Residency", 
                message: "You do not meet the Australian residency requirements for subsidised training. You will be enrolled as a full fee-paying international or domestic student. We will confirm the exact fee upon submission.", 
                program: "Certificate III/IV in Dental Assisting (Student)", 
                category: "Fee-paying student" 
            },
            'error_generic': { 
                title: "Quiz Error", 
                message: "An unexpected error occurred in the quiz flow. Please try restarting, or contact us for direct assistance.", 
                program: "Error", 
                category: "Error" 
            }
        };

        /**
         * Calculates the final eligibility result based on user answers.
         * @returns {object} The result object from the 'results' map.
         */
        function getQuizResult() {
            // Priority 1: Residency failure (Fee-paying)
            if (answers.residency === 'no') {
                return results.fee_paying_residency;
            }

            // Priority 2: Currently employed in dental field (Highly Eligible)
            if (answers.employment === 'dental_employed') {
                return results.eligible_dental_employed;
            }
            
            // Priority 3: Existing higher qualification (Likely Fee-Paying)
            if (answers.qualification_held === 'yes') {
                 // Note: Residency is 'yes' due to Priority 1 check
                 return results.fee_paying_qualification;
            }
            
            // Priority 4: General eligibility (All other 'yes' answers)
            // This covers Australian residents, non-higher qualified, non-dental employed/unemployed.
            if (answers.residency === 'yes' && answers.education === 'yes') {
                return results.eligible_general;
            }

            // If we fall through, something unexpected happened or criteria wasn't met.
            return results.error_generic;
        }

        /**
         * Renders the current step's content.
         * @param {number} index - The index of the step to render.
         */
        function renderStep(index) {
            const step = steps[index];
            const contentDiv = document.getElementById('step-content');
            const progressBar = document.getElementById('progress-bar');
            const stepCounter = document.getElementById('step-counter');
            
            // Set progress bar and counter
            const progress = (index / (steps.length - 1)) * 100;
            progressBar.style.width = `${progress}%`;
            stepCounter.textContent = `Step ${currentVisibleStep} of ${steps.length}`;

            let htmlContent = `
                <div class="step-transition">
                    <p class="text-xl font-semibold mb-4 text-gray-800">${step.question}</p>
                    <form id="step-form">
            `;

            if (step.type === 'radio') {
                step.options.forEach(option => {
                    const isChecked = answers[step.name] === option.value;
                    htmlContent += `
                        <div class="mb-3">
                            <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100 transition duration-150">
                                <input type="radio" name="${step.name}" value="${option.value}" 
                                    class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" 
                                    ${isChecked ? 'checked' : ''}
                                    onchange="enableButton()">
                                <span class="ml-3 text-gray-700 font-medium">${option.label}</span>
                            </label>
                        </div>
                    `;
                });
            } else if (step.type === 'text') {
                 // Pre-fill if answer exists
                 const value = answers[step.name] || ''; 

                 htmlContent += `
                    <div class="mb-3">
                        <input type="text" id="${step.name}" name="${step.name}" value="${value}"
                            placeholder="${step.placeholder || ''}"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                            onkeyup="validateInputFields()" onchange="validateInputFields()">
                        <p id="${step.name}-warning" class="input-warning hidden"></p>
                    </div>
                 `;
            }

            htmlContent += `
                    </form>
                </div>
            `;
            
            contentDiv.innerHTML = htmlContent;

            // Immediately validate fields for text steps if they have content
            if (step.type === 'text') {
                validateInputFields();
            } else {
                // Ensure button is enabled if a radio answer is already selected
                enableButton();
            }
            
            // Restore History button if applicable
            document.getElementById('history-button').classList.remove('hidden');
        }

        /**
         * Validates input fields and enables the Next button.
         */
        window.validateInputFields = function() {
            const step = steps[currentStepIndex];
            let isValid = true;

            if (step.type === 'radio') {
                // Check if any radio button is selected
                const form = document.getElementById('step-form');
                const selected = form ? form.querySelector(`input[name="${step.name}"]:checked`) : null;
                isValid = !!selected;
            } else if (step.type === 'text') {
                const input = document.getElementById(step.name);
                const warning = document.getElementById(`${step.name}-warning`);
                const validationError = step.validation ? step.validation(input.value) : null;
                
                if (validationError) {
                    warning.textContent = validationError;
                    warning.classList.remove('hidden');
                    isValid = false;
                } else {
                    warning.classList.add('hidden');
                    // Store valid answer temporarily to re-fill if going back
                    answers[step.name] = input.value;
                    isValid = true;
                }
            }

            // Update button state
            const nextButton = document.getElementById('next-button');
            nextButton.disabled = !isValid;
        }

        // Alias for validateInputFields for radio buttons
        window.enableButton = window.validateInputFields;


        /**
         * Progresses the quiz to the next step or shows results.
         */
        window.nextStep = function() {
            const step = steps[currentStepIndex];
            const nextButton = document.getElementById('next-button');

            // 1. Collect answer for the current step
            if (step.type === 'radio') {
                const selected = document.querySelector(`input[name="${step.name}"]:checked`);
                if (!selected) return; // Should not happen if button is enabled
                answers[step.name] = selected.value;
            } else if (step.type === 'text') {
                const input = document.getElementById(step.name);
                if (!input || step.validation(input.value)) return;
                answers[step.name] = input.value;
            }
            
            // 2. Advance step or finish
            currentStepIndex++;
            currentVisibleStep++;
            nextButton.disabled = true; // Disable button for the next step immediately

            if (currentStepIndex < steps.length) {
                // Render the next step
                renderStep(currentStepIndex);
            } else {
                // Quiz complete, show results
                showResults();
            }
        }

        /**
         * Renders the final results screen.
         */
        function showResults() {
            const result = getQuizResult();
            const contentDiv = document.getElementById('step-content');
            const nextButton = document.getElementById('next-button');
            const restartButton = document.getElementById('restart-button');
            const progressBar = document.getElementById('progress-bar');
            const stepCounter = document.getElementById('step-counter');

            // Final progress bar/counter display
            progressBar.style.width = '100%';
            stepCounter.textContent = `Completed!`;

            // Hide Next, show Restart
            nextButton.classList.add('hidden');
            restartButton.classList.remove('hidden');
            
            // Update History button text
            document.getElementById('history-button').textContent = 'View My Results History';
            document.getElementById('history-button').onclick = window.loadQuizHistory;

            // Render result content
            contentDiv.innerHTML = `
                <div class="text-center p-4">
                    <svg class="w-12 h-12 text-blue-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h2 class="text-2xl font-bold mb-3 text-blue-700">${result.title}</h2>
                    <p class="text-gray-600 mb-4">${result.message}</p>
                    
                    <div class="text-left bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-sm font-semibold text-gray-700">Program Enquired:</p>
                        <p class="text-lg font-medium text-blue-600 mb-2">${result.program}</p>
                        <p class="text-sm font-semibold text-gray-700">Eligibility Category:</p>
                        <p class="text-base text-gray-800">${result.category}</p>
                        <p class="text-xs text-gray-500 mt-2">A full enrolment application is required to confirm final eligibility.</p>
                    </div>
                </div>
            `;
            
            // Save the result to Firestore
            window.saveQuizResult(result, answers);
        }

        // Expose startQuiz to window so it can be called by the restart button and the init
        window.startQuiz = function() {
            if (!isAuthReady) {
                document.getElementById('step-content').innerHTML = '<p class="text-center text-gray-500">Waiting for authentication to complete...</p>';
                return;
            }
            currentStepIndex = 0;
            currentVisibleStep = 1;
            answers = {};
            document.getElementById('next-button').classList.remove('hidden');
            document.getElementById('restart-button').classList.add('hidden');
            
            // Reset and hide status message
            const statusMessage = document.getElementById('save-status-message');
            statusMessage.classList.add('hidden');
            statusMessage.textContent = '';
            
            // Reset History button text and function
            document.getElementById('history-button').textContent = 'View My Results History';
            document.getElementById('history-button').onclick = window.loadQuizHistory;
            
            renderStep(currentStepIndex);
        }

        // Initialize the quiz on load
        // Note: initializeFirebase is called on window.onload, and startQuiz is called upon successful authentication.

    </script>

</body>
</html>
